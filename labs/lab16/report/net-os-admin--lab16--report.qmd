---
## Author
author:
  name: Кхари Жекка Кализая Арсе
  email: 1032234412@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа № 16"
subtitle: "Базовая защита от атак типа «brute force»"
license: "CC BY"
---

# Цель работы

Получить навыки работы с программным средством Fail2ban для обеспечения базовой защиты от атак типа «brute force»

# Задание

1. Установите и настройте Fail2ban для отслеживания работы установленных на сервере служб (см. раздел 16.4.1).
2. Проверьте работу Fail2ban посредством попыток несанкционированного доступа
с клиента на сервер через SSH (см. раздел 16.4.2).
3. Напишите скрипт для Vagrant, фиксирующий действия по установке и настройке
Fail2ban (см. раздел 16.4.3).


# Выполнение лабораторной работы

## Защита с помощью Fail2ban

Сначала я установил fail2ban в сервере

    dnf -y install fail2ban

![установка fail2ban](image/01.jpg){#fig-001 width=70%}

Потом я запустил службу

    systemctl start fail2ban
    systemctl enable fail2ban

![запуск службы fail2ban](image/02.jpg){#fig-002 width=70%}


Потом в дургом окне я смотрел логи чтобы проверять что служба работает правильно

    tail -f /var/log/fail2ban.log

![журнал](image/03.jpg){#fig-003 width=70%} 


Потом я создал файл для конфигурации fail2ban jail 

    touch /etc/fail2ban/jail.d/customisation.local

![файл конфигурации](image/04.jpg){#fig-004 width=70%}  

Дальше я открыл его с помощью nano и там я написал настройку 

    [DEFAULT]
    bantime = 3600

это значить что, если один ip адрес блокируется, то через 1 час он разблокируется

![конфигурация](image/05.jpg){#fig-005 width=70%}

потом я добавил следующие строки

    #
    # SSH servers
    #
    [sshd]
    port = ssh,2022
    enabled = true
    [sshd-ddos]
    filter = sshd
    enabled = true
    [selinux-ssh]
    enabled = true

это значить актирована защита для протокола ssh через порт 2022. также добавить дополнительную защиту против атаков ddos, также наблюдает selinux.

![конфигурация](image/06.jpg){#fig-006 width=70%}


Потом я перезагрузил службу fail2ban

    systemctl restart fail2ban

![перезагрузка fail2ban](image/07.jpg){#fig-007 width=70%}

Дальше я смотрел журнал чтобы проверать правильную работу службы

    tail -f /var/log/fail2ban.log

![журнал](image/08.jpg){#fig-008 width=70%}

там я смог смотреть как включаются мои настройки


Дальше я добавил другие строки в то же файл конфигурации

    [apache-auth]
    enabled = true
    [apache-badbots]
    enabled = true
    [apache-noscript]
    enabled = true
    [apache-overflows]
    enabled = true
    [apache-nohome]
    enabled = true
    [apache-botsearch]
    enabled = true
    [apache-fakegooglebot]
    enabled = true
    [apache-modsecurity]
    enabled = true
    [apache-shellshock]
    enabled = true

![конфигурация](image/09.jpg){#fig-00 width=70%}

`[apache-auth]`  - Блокирует IPs сбоев при проверке подлинности HTTP
`[apache-badbots]` - Блокирует известных вредоносных ботов
`[apache-noscript]` - Блокирует попытки запуска запрещенных сценариев
`[apache-overflows]` - Обнаруживает аномально длинные запросы
`[apache-nohome]` - Блокирует доступ к несуществующим каталогам ~user
`[apache-botsearch]` - Обнаруживает автоматическое сканирование сайтов
`[apache-fakegooglebot]` - Блокирует ботов, выдающих себя за роботов Googlebot
`[apache-modsecurity]` - Интеграция Fail2Ban c системой ModSecurity
`[apache-shellshock]` - Протеже против атакующего снаряда (CVE-2014-6271)

Потом я перезагрузил службу

    systemctl restart fail2ban

![перезагрузка](image/10.jpg){#fig-010 width=70%}

Потом я смотрел логи (в моем случае у меня была ошибка при применении такие настройки потому что у меня служба httpd стал не работать, но я это решил и все работал хорошо)

    tail -f /var/log/fail2ban.log

![журнал](image/11.jpg){#fig-011 width=70%}

Потом я добавил последные строки чтобы закончить настройку

    [postfix]
    enabled = true
    [postfix-rbl]
    enabled = true
    [dovecot]
    enabled = true
    [postfix-sasl]
    enabled = true

![конфигурация](image/12.jpg){#fig-012 width=70%}

`[postfix]` - Защищает почтовый сервер Postfix
`[postfix-rbl]` - использует RBL (realtime balckhole lists)
`[dovecot]` - защищает IMAP/POP3
`[postfix-sasl]` - защищает SMTP(SASL)

Потом я перезагрузил службу

    systemctl restart fail2ban

![перезагрузка](image/13.jpg){#fig-013 width=70%}

и смотрел журнал

    tail -f /var/log/fail2ban.log

![журнал](image/14.jpg){#fig-014 width=70%}


## Проверка работы Fail2ban

в сервере я смотрел статус fail2ban

    fail2ban-client status

![статус службы fail2ban](image/15.jpg){#fig-015 width=70%}

здесь я смог смотреть list jail, в котором я могу смотреть защитые службые и также количесво служб


Потом я смотрел статус защиты SSH

    fail2ban-client status sshd

![статус SSHD](image/16.jpg){#fig-016 width=70%}

Здесь показывается информация о том, какие ip-адресы заблокированны, количество заблокированных ip-адресов, количество неудачных попыток, тд.

потом я установил максимальное количество ошибок для ssh, равное 2

    fail2ban-client set sshd maxretry 2

![максимальное количество ошибок](image/17.jpg){#fig-017 width=70%}

На клиенте я намеренно выполнял неудачные попытки подключения к серверу по SSH для проверки работы Fail2Ban.

![проверка с клиента](image/18.jpg){#fig-018 width=70%}

Дальше в сервере я смотрел еще раз статус защиты ssh

    fail2ban-client status sshd

![результаты проверки](image/19.jpg){#fig-019 width=70%}

там я смог смотреть как ip-адрес клиента заблокирован 

Потом я разблокировал то же ip-адрес 

    fail2ban-client set sshd unpanip 192.168.1.11

![разблокировка](image/20.jpg){#fig-020 width=70%}

и проверил его 

    fail2ban-client status sshd

![статус sshd](image/21.jpg){#fig-021 width=70%}

В списке Banned IP list IP-адрес клиента больше не отображается.

Дальше я добавил новую строку в файле конфигурации чтобы указать какой IP-адрес не должен блокироваться

    [DEFAULT]
    bantime = 3600
    ignoreip = 127.0.0.1/8 192.168.1.11

![разрешенные IP-адресы](image/22.jpg){#fig-022 width=70%}

и перезагрузил слжубу и смотрел журнал

    systemctl restart fail2ban

![перезагрузка службу fail2ban](image/23.jpg){#fig-023 width=70%}

![журнал](image/24.jpg){#fig-024 width=70%}

Потом я еще раз на клиенте намеренно выполнял неудачные попытки подключения к серверу по SSH для проверки работы новой конфигурации

![проверка](image/25.jpg){#fig-025 width=70%}

и смотрел в сервере еще раз статус sshd

    fail2ban-client status sshd

![результаты проверки](image/26.jpg){#fig-026 width=70%}


## Внесение изменений в настройки внутреннего окружения виртуальных машин

как обычно я создал необходимые каталоги и файлы для скрипта чтобы повторить все действия сделанны при выполнении лабораторной работы

    cd /vagrant/provision/server
    mkdir -p /vagrant/provision/server/protect/etc/fail2ban/jail.d
    cp -R /etc/fail2ban/jail.d/customisation.local /vagrant/provision/server/protect/etc/fail2ban/jail.d/
    cd /vagrant/provision/server
    touch protect.sh
    chmod +x protect.sh

![каталоги и файлы](image/27.jpg){#fig-027 width=70%}

и поставил скрипт

![скрипт](image/28.jpg){#fig-028 width=70%} 

Потом в vagrantfile я добавил инструкции для выполнения скрипта

![vagrantfail](image/29.jpg){#fig-029 width=70%}

# Выводы

В этой лабораторной работе я смог смотреть как настроеть службу fail2ban и как он блокирует ip-адресы чтобы защищать службы в сервере против атак 

# Список литературы{.unnumbered}

::: {#refs}
:::
